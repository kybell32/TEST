<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p7b</title>
<style>
  :root{--line:#e5e7eb;--pri:#2563eb;--bg:#f6f7f9;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;line-height:1.6}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px;text-align:center;font-weight:700}
  main{max-width:980px;margin:0 auto;padding:18px}
  h1{font-size:20px;margin:6px 0 12px}
  .section{margin:14px 0 28px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:16px}
  .title{font-weight:700;margin:0 0 6px}
  .help{font-size:12px;color:var(--muted);margin:0 0 10px}
  .q{border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .qname{font-weight:700;margin-bottom:8px}
  .scale{display:flex;flex-wrap:nowrap;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .scale::-webkit-scrollbar{display:none}
  label.chip{position:relative;display:inline-flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 10px;background:#fff;cursor:pointer;user-select:none;white-space:nowrap;line-height:1;transition:background .15s,border-color .15s,box-shadow .15s;font-size:14px}
  label.chip>input{position:absolute;inset:0;opacity:0;width:100%;height:100%;margin:0;cursor:pointer}
  label.chip strong{font-variant-numeric:tabular-nums;font-weight:700}
  label.chip:hover{background:#f9fafb}
  label.chip:focus-within{box-shadow:0 0 0 3px rgba(37,99,235,.2)}
  label.chip.selected{background:#eef2ff;border-color:#93c5fd;box-shadow:inset 0 0 0 2px #2563eb}
  label.chip.selected strong{color:#1d4ed8}
  .btn-area{text-align:center;margin-top:24px}
  .btn{border:none;border-radius:10px;padding:12px 20px;font-size:16px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  @media (max-width:480px){
    main{padding:12px}
    .card{padding:12px}
    .q{padding:12px}
    .scale{gap:6px}
    label.chip{padding:8px 9px;font-size:13.5px}
  }
</style>
</head>
<body>
<header>설문 (2/2)</header>
<main>
  <h1>아래 문항에 응답해 주세요.</h1>

  <section class="section">
    <div class="card">
      <p class="title"><b>정신질환자들</b>이 아래에 제시되는 문장 속의 내용과 얼마나 일치하는지에 대해 동의하는 정도를 선택해 주십시오.</p>
      <p class="help">1(전혀 그렇지 않다) ~ 7(매우 그렇다)</p>
      <div id="sec3"></div>
    </div>
  </section>

  <div class="btn-area">
    <button id="nextBtn" class="btn" disabled>다음</button>
  </div>
</main>

<script type="module">
  /***** ▼ Firebase 초기 설정 ▼ *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCEZEZItyfBTMg8tVWv3RQX19r6R-71pME",
    authDomain: "to-be-a-master.firebaseapp.com",
    projectId: "to-be-a-master",
    storageBucket: "to-be-a-master.firebasestorage.app",
    messagingSenderId: "223906864735",
    appId: "1:223906864735:web:a04b3fdfa88e48a99905ea",
    measurementId: "G-SXF1BMH4DB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  /***** ▲ Firebase 설정 끝 ▲ *****/

  /***** ▼ 페이지 설정 ▼ *****/
  const PAGE = 7;
  const NEXT_PAGE_URL = "page8.html";
  /***** ▲ 설정 끝 ▲*/

  (function(){
    const qs = new URLSearchParams(location.search);
    const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
    const nextBtn = document.getElementById('nextBtn');
    let sending = false;

    // 칩 생성
    document.querySelectorAll('.scale').forEach(scale=>{
      const name = scale.dataset.name;
      for(let v=1; v<=5; v++){
        const lab=document.createElement('label');
        lab.className='chip';
        lab.innerHTML=`<input type="radio" name="${name}" value="${v}"><strong>${v}</strong>`;
        scale.appendChild(lab);
      }
    });

    function refreshGroup(name){
      document.querySelectorAll(`label.chip input[name="${name}"]`).forEach(r=>{
        const lab=r.closest('label.chip');
        lab.classList.toggle('selected',r.checked);
      });
    }

    document.addEventListener('change',e=>{
      if(e.target.matches('input[type="radio"]')){
        refreshGroup(e.target.name);
        refreshBtn();
      }
    });

    const REQUIRED=['q1','q2','q3'];
    function allAnswered(){return REQUIRED.every(n=>document.querySelector(`input[name="${n}"]:checked`));}
    function refreshBtn(){nextBtn.disabled=!allAnswered()||sending;}
    refreshBtn();

    // ✅ Firestore 저장
    async function saveToFirestore(answers){
      if(!pid) return;
      try {
        await addDoc(collection(db, "responses"), {
          pid,
          page: PAGE,
          answers,
          timestamp: new Date()
        });
        console.log("✅ Firestore 저장 완료 (page 7)");
      } catch(e){
        console.error("❌ Firestore 저장 실패:", e);
        throw e;
      }
    }

    nextBtn.addEventListener('click', async ()=>{
      if(!allAnswered()||sending) return;
      sending = true; refreshBtn();

      function valOf(name){return document.querySelector(`input[name="${name}"]:checked`).value;}
      const answers=[
        {key:'P6_Q1',value:valOf('q1')},
        {key:'P6_Q2',value:valOf('q2')},
        {key:'P6_Q3',value:valOf('q3')}
      ];

      try{
        await saveToFirestore(answers);
        // 약간의 지연 → 네트워크 플러시 확보
        await new Promise(r=>setTimeout(r,300));
      }catch(e){console.warn(e);}

      location.href=`${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    });

  })();
</script>

</body>
</html>
