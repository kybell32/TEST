<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEZEZItyfBTMg8tVWv3RQX19r6R-71pME",
  authDomain: "to-be-a-master.firebaseapp.com",
  projectId: "to-be-a-master",
  storageBucket: "to-be-a-master.firebasestorage.app",
  messagingSenderId: "223906864735",
  appId: "1:223906864735:web:a04b3fdfa88e48a99905ea",
  measurementId: "G-SXF1BMH4DB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const PAGE = 2;
const NEXT_PAGE_URL = "page3.html";

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  const nextBtn = document.getElementById('nextBtn');
  let sending = false;

  // ✅ Firestore에 세션 정보 저장 (answers 배열 포함)
  async function sessionUpsert() {
    try {
      // 현재 페이지에서 수집할 답변 데이터 예시
      // 실제 설문 폼 요소에서 값을 가져오도록 변경 가능
      const answers = [
        { question: "연구 설명 확인", answer: "예" },
        { question: "연구 안내 확인", answer: "예" },
        { question: "연구 대상자 관련 자료 처리 확인", answer: "예" }
      ];

      await addDoc(collection(db, "responses"), {
        pid,
        page: PAGE,
        answers,        // 배열 구조로 저장
        timestamp: new Date()
      });

      console.log("✅ Firestore 저장 완료 (page 2)");
    } catch (e) {
      console.error("❌ Firestore 저장 실패:", e);
    }
  }

  nextBtn.addEventListener('click', async () => {
    if (sending) return;
    sending = true;
    nextBtn.disabled = true;
    await sessionUpsert();
    const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
    location.href = next;
  });

})();
</script>
