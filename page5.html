<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p5 </title>
<style>
  :root{--bg:#ffffff;--line:#e5e7eb;--pri:#2563eb;--muted:#6b7280}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827;display:flex;align-items:center;justify-content:center}
  .popup{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.08);padding:24px;max-width:420px;width:100%;text-align:center}
  h1{font-size:18px;margin:0 0 12px}
  p{margin:8px 0;color:#374151}
  .muted{color:var(--muted);font-size:13px}
  .btn{border:none;border-radius:10px;padding:12px 16px;background:var(--pri);color:#fff;font-weight:700;cursor:pointer;margin-top:14px}
  .btn:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
  <main class="popup" aria-labelledby="ttl">
    <h1 id="ttl">실험 안내</h1>
    <p>다음은 한 소셜 미디어에 게시된 글입니다.</p>
    <p class="muted">글은 <strong>45초</strong>간 제시됩니다.</p>
    <button id="go" class="btn">읽기</button>
  </main>

<script type="module">
  /***** ▼ Firebase 초기 설정 ▼ *****/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCEZEZItyfBTMg8tVWv3RQX19r6R-71pME",
    authDomain: "to-be-a-master.firebaseapp.com",
    projectId: "to-be-a-master",
    storageBucket: "to-be-a-master.firebasestorage.app",
    messagingSenderId: "223906864735",
    appId: "1:223906864735:web:a04b3fdfa88e48a99905ea",
    measurementId: "G-SXF1BMH4DB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  /***** ▲ Firebase 설정 끝 ▲ *****/


  /***** ▼ 페이지 설정 ▼ *****/
  const PAGE = 5;
  const NEXT_PAGE_URL = "page6.html";
  /***** ▲ 설정 끝 ▲ *****/

  (function(){
    const qs = new URLSearchParams(location.search);
    const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
    const go = document.getElementById('go');
    let sending = false;

    // ✅ Firestore에 메타 데이터 저장
    async function sessionUpsert() {
      try {
        await addDoc(collection(db, "responses"), {
          pid,
          page: PAGE,
          answers: [], // 수집값 없음
          timestamp: new Date()
        });
        console.log("✅ Firestore 저장 완료 (page 5)");
      } catch (e) {
        console.error("❌ Firestore 저장 실패:", e);
        throw e;
      }
    }

    go.addEventListener('click', async ()=>{
      if (sending) return;
      sending = true;
      go.disabled = true;
      try {
        await sessionUpsert();
        const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
        location.href = next;
      } catch(e) {
        console.warn(e);
        alert('데이터 저장에 실패했습니다. 다시 시도해주세요.');
        sending = false;
        go.disabled = false;
      }
    });
  })();
</script>

</body>
</html>
