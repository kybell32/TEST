<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p5</title>
<style>
  :root{--bg:#f6f7f9;--card:#fff;--line:#e5e7eb;--pri:#2563eb;--muted:#6b7280}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;color:#111827}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;z-index:10}
  header .inner{max-width:760px;margin:0 auto;display:flex;align-items:center;gap:10px}
  .brand{font-weight:700}
  .spacer{flex:1}
  .timer{font-variant-numeric:tabular-nums}
  main{max-width:760px;margin:16px auto;padding:0 16px}
  .post{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;align-items:center}
  .avatar{width:40px;height:40px;border-radius:999px;background:#d1d5db}
  h2{margin:0;font-size:18px}
  .meta{font-size:12px;color:var(--muted)}
  .content{margin-top:10px;white-space:pre-wrap;line-height:1.7}
  .stats{display:flex;gap:16px;align-items:center;color:#374151;margin-top:12px;font-size:14px}
  .progress{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:12px}
  .bar{height:100%;width:0%;background:var(--pri)}
</style>
</head>
<body>
<header>
  <div class="inner">
    <div class="brand">피드</div>
    <div class="spacer"></div>
    <div class="timer"><span id="sec">45</span>s</div>
  </div>
</header>

<main>
  <article class="post">
    <div class="row">
      <div class="avatar" aria-hidden="true"></div>
      <div>
        <h2 id="title">제목</h2>
        <div class="meta">@user • 지금</div>
      </div>
    </div>
    <div id="body" class="content"></div>
    <div class="stats">
      <div>공유 <strong id="shareCnt">0</strong></div>
      <div>좋아요 <strong id="likeCnt">0</strong></div>
      <div>댓글 <strong id="commentCnt">0</strong></div>
      <div>저장 <strong id="saveCnt">0</strong></div>
    </div>
    <div class="progress"><div id="bar" class="bar"></div></div>
  </article>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEZEZItyfBTMg8tVWv3RQX19r6R-71pME",
  authDomain: "to-be-a-master.firebaseapp.com",
  projectId: "to-be-a-master",
  storageBucket: "to-be-a-master.firebasestorage.app",
  messagingSenderId: "223906864735",
  appId: "1:223906864735:web:a04b3fdfa88e48a99905ea",
  measurementId: "G-SXF1BMH4DB"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const DURATION_SEC = 45;
const NEXT_PAGE_URL = "page7.html";

(function(){
  const qs = new URLSearchParams(location.search);
  const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
  if (!pid) console.warn("pid가 비어 있습니다. 로그 기록 불가!");

  const stimuli = {
    A: { key: 'A', title: '정치병자들이 물에 빠졌다.txt', body: `...내용 생략...` },
    B: { key: 'B', title: '정치병자들은 답이 없다.', body: `...내용 생략...` }
  };

  let variantKey = localStorage.getItem('stimulus_variant');
  if (!variantKey) {
    variantKey = Math.random() < 0.7 ? 'A' : 'B';
    localStorage.setItem('stimulus_variant', variantKey);
  }
  const variant = stimuli[variantKey];

  document.getElementById('title').textContent = variant.title;
  document.getElementById('body').textContent = variant.body;

  const counts = (() => {
    const save = 30 + Math.floor(Math.random()*71);
    const comment = save + 20 + Math.floor(Math.random()*181);
    const like = comment + 50 + Math.floor(Math.random()*601);
    const share = Math.min(2000, like + 100 + Math.floor(Math.random()*901));
    return {share, like, comment, save};
  })();
  document.getElementById('shareCnt').textContent = counts.share.toLocaleString();
  document.getElementById('likeCnt').textContent = counts.like.toLocaleString();
  document.getElementById('commentCnt').textContent = counts.comment.toLocaleString();
  document.getElementById('saveCnt').textContent = counts.save.toLocaleString();

  let saved = false;

  async function saveVariant() {
    if (!pid || saved) return;
    try {
      const answers = [
        {
          key: 'P6_VARIANT',
          value: variant.key,
          detail: `노출 자극 ${variant.key} (${variant.title})`
        }
      ];
      const docRef = doc(db, "responses", pid);
      await setDoc(docRef, {
        page_6: { answers, timestamp: serverTimestamp() }
      }, { merge: true });
      console.log("✅ Firestore 저장 완료 (page 6)");
      saved = true;
    } catch(e) {
      console.error("❌ Firestore 저장 실패:", e);
    }
  }

  function redirectNext() {
    saveVariant().finally(()=>{
      const next = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
      location.href = next;
    });
  }

  const secEl = document.getElementById('sec');
  const barEl = document.getElementById('bar');
  let left = DURATION_SEC;
  secEl.textContent = left;
  barEl.style.width = '0%';

  const tick = setInterval(()=>{
    left = Math.max(0, left-1);
    secEl.textContent = left;
    barEl.style.width = ((DURATION_SEC-left)/DURATION_SEC)*100 + '%';
    if(left===0){
      clearInterval(tick);
      redirectNext();
    }
  },1000);

  //  안전장치
  setTimeout(redirectNext, DURATION_SEC*1000 + 500);
})();
</script>


</body>
</html>
