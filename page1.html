<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>소셜 미디어 연구_p1</title>
<style>
body {
  margin:0;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#f6f7f9;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif;
  color:#111827;
}
.popup {
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,.1);
  padding:22px;
  max-width:310px;
  width:100%;
  text-align:center;
}
h1 {
  font-size:18px;
  margin:0 0 12px;
}
.row {
  display:flex;
  gap:8px;
  justify-content:center;
}
input[type="text"] {
  width:60px;
  padding:0.45em;
  font-size:1em;
  text-align:center;
  box-sizing:border-box;
  border:1px solid #ccc;
  border-radius:8px;
  letter-spacing:4px;
}
button {
  width:60px;
  padding:0.3em 0.5em;
  font-size:1em;
  box-sizing:border-box;
  border:none;
  background:#2563eb;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.hint {
  font-size:12px;
  color:#6b7280;
  margin-top:8px;
}
/* 모바일 대응 */
@media (max-width:480px) {
  input[type="text"], button { width:auto; }
}
</style>
</head>
<body>

<div class="popup">
  <h1>전화 번호 뒷자리 4개를 입력해 주세요.</h1>
  <div class="row">
    <input id="idtail" type="text" inputmode="numeric" maxlength="4" placeholder="4자리" />
    <button id="submitBtn">입력</button>
  </div>
  <div class="hint">번호를 잘 확인해 주세요.</div>
</div>

<!-- Firebase SDK -->
<script type="module">
  // ✅ Firebase SDK 불러오기
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  // ✅ Firebase 설정 (본인 프로젝트 값 그대로 사용)
  const firebaseConfig = {
    apiKey: "AIzaSyCEZEZItyfBTMg8tVWv3RQX19r6R-71pME",
    authDomain: "to-be-a-master.firebaseapp.com",
    projectId: "to-be-a-master",
    storageBucket: "to-be-a-master.firebasestorage.app",
    messagingSenderId: "223906864735",
    appId: "1:223906864735:web:a04b3fdfa88e48a99905ea",
    measurementId: "G-SXF1BMH4DB"
  };

  // ✅ Firebase & Firestore 초기화
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener('DOMContentLoaded', () => {
    const PAGE = 3;
    const NEXT_PAGE_URL = "page4.html";

    const qs = new URLSearchParams(location.search);
    const pid = qs.get('pid') || localStorage.getItem('exp_pid') || '';
    const nextBtn = document.getElementById('nextBtn');
    const pname = document.getElementById('pname');
    const qNames = ['q1', 'q2', 'q3', 'q4'];

    function getAnswers() {
      const out = {};
      for (const n of qNames) {
        const v = (document.querySelector(`input[name="${n}"]:checked`) || {}).value || null;
        out[n] = v;
      }
      return out;
    }

    function allYes(ans) {
      return ans.q1 === '예' && ans.q2 === '예' && ans.q3 === '예' && ans.q4 === '예';
    }

    function syncState() {
      const ans = getAnswers();
      nextBtn.disabled = !(allYes(ans) && pname.value.trim());
    }

    document.querySelectorAll('input[type="radio"]').forEach(el => el.addEventListener('change', syncState));
    pname.addEventListener('input', syncState);

    // ✅ Firestore에 데이터 저장 함수
    async function saveToFirestore(data) {
      try {
        await addDoc(collection(db, "responses"), data);
        console.log("✅ Firestore 저장 성공");
      } catch (e) {
        console.error("❌ Firestore 저장 실패:", e);
        throw e;
      }
    }

    nextBtn.addEventListener('click', async () => {
      const ans = getAnswers();
      if (!allYes(ans)) return;
      const name = pname.value.trim();

      const answers = {
        pid,
        page: PAGE,
        P3_Q1: ans.q1,
        P3_Q2: ans.q2,
        P3_Q3: ans.q3,
        P3_Q4: ans.q4,
        P3_NAME: name,
        timestamp: new Date()
      };

      nextBtn.disabled = true; // 중복 클릭 방지

      try {
        // ✅ Firestore에 저장
        await saveToFirestore(answers);

        // 저장 성공 시 다음 페이지로 이동
        location.href = `${NEXT_PAGE_URL}?pid=${encodeURIComponent(pid)}`;
      } catch (e) {
        console.warn('데이터 저장 실패:', e);
        alert('데이터 저장에 실패했습니다. 인터넷 연결을 확인하고 다시 시도해주세요.');
        nextBtn.disabled = false; // 재시도 가능
      }
    });
  });
</script>


</body>
</html>
